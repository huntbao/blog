---
layout: post
title: 如何愉快地编写 Parser —— PEG.js 介绍
category: js
tag: js pegjs
hidden: true
---
在编写程序的时候，我们经常需要处理文本内容，从目标文本中提取有效信息，然后再交给其他程序进行处理。最常用的文本处理工具就是正则表达式，相信大家都已经用过。还有一种方式就是编写 Parser。[Mustache.js](https://github.com/janl/mustache.js) 的最初版本也是用正则表达式编写的，后来被其他人改用了 Parser，这一点也让作者唏嘘不已。

除了开发一些效率工具，在日常的开发工作中，直接编写 Parser 似乎是很少见的。一来可能是编写 Parser 有较高的门槛，二来也可能是对这方面的知识缺乏关注。

但是，在日常的开发工作中，如果在有一些需求功能中使用自己编写的 Parser，那么不管产品经理的需求更改有多频繁和变态，也不需要去修改代码了，因为该 Parser 能应付所有可能出现的情形。

举个例子，开发一个按日期条件过滤的筛选器，一开始产品经理给出了这些筛选条件：“三天内”、“一周内”、“一月前”。这是一个很大的坑，如果代码不好好设计下，那就做好加班的心理准备吧。因为业界根本没有通用的日期筛选条件规则，不可能有也不需要有，所以很可能会出现各种各样的筛选条件：“半个月前”、“三天之前十天之内”等等。所以，很有必要将筛选规则通用化，然后编写 Parser 解析规则，提取有效信息。比如 “三天之前十天之内” 可以用 “>3d<10d” 来表示，然后将该规则写在筛选按钮的属性上，这样就不用修改代码了。

可能有人会说，这也不用编写 Parser 那么麻烦吧，正则表达式绰绰有余了。

说得很对，但是这不重要，正则表达式也会总有力不从心的时候。今天要介绍的工具 PEG.js，是用来解决“编写 Parser 这个麻烦”的。PEG.js 的文法对前端工程师特别友好，只要掌握基本的正则语法就足够了，生成的 Parser 是一个 JavaScript 文件，在浏览器端和 Node.js 中都可以使用。


## 入门

PEG.js 有[在线版本](http://pegjs.org/online)，推荐从它开始练手，请在新窗口打开这个链接。

打开后，请将左边的 textarea 中的内容删除，这时它的下方会有警告信息，在 textarea 中输入下面的内容：

```js
StartRule = ""
```

此时警告信息就消失了，将右边的 textarea 的内容也删除。

接下来我们使用 PEG.js 语法来生成一个 Parser，用来检验一段输入文本是否为有效的 CSS 规则，为了方便起见，我们规定“有效的 CSS 规则”是这样的：

```css
.SELECTOR {
  PROPERTY: VALUE;
}

```

规则说明：
1. 只能以 “.” 开头，后面紧跟选择器名称 SELECTOR，SELECTOR 只能由英文字母组成
2. SELECTOR 后面可以是任意数量的空白字符或者换行符，然后是左大括号
3. 左大括号之后可以跟换行符加任意数量的空白字符，也可以没有换行符
4. PROPERTY 只能由英文字母组成，PROPERTY 后面可以是任意数量的空白字符，然后再出现冒号“:”
5. 冒号“:”后面可以是任意数量的空白字符，然后再出现 VALUE，VALUE 只能由英文字母和数字组成
6. VALUE 后面可以是任意数量的空白字符，然后是分号“;”
7. 最后是右大括号

根据上面的规则说明，可以知道下面的都是“有效的 CSS 规则”：

```css
.main{margin: 20px;}

.main { margin  : 20px;  }

.main
{
  margin  : 20px;  
}
```

但下面的都不是“有效的 CSS 规则”：
```css
/** 最前面有空格，不符合规则 1 **/
 .main{margin: 20px;}

/** SELECTOR 不全是英文字母，不符合规则 1 **/
.m-main { margin  : 20px;  }

/** PROPERTY 不全是英文字母，不符合规则 4 **/
.main
{
  font-size : 20px;  
}
```

如果是“有效的 CSS 规则”，就返回下面的 JSON 对象：

```json
{
  "selector": "{{SELECTOR}}",
  "property": "{{PROPERTY}}",
  "value": "{{VALUE}}"
}
```
